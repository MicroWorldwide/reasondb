!function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){t.exports=n(4)},function(t,e){t.exports=require("crypto")},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("nano-pipe")},function(t,e,n){"use strict";function s(t){const e=t(""),n=Object.getPrototypeOf(e);return Object.getPrototypeOf(async function*(){}()).constructor===n.constructor?(n.every=async function(t){let e=0;for(;this.length>=0&&!this.done;e++){const n=await this[e];if(!this.done&&!await t(n,e,this))return 0}for await(const n of this)if(!await t(n,e++,this))return 0;return e},n.find=async function(t){let e=0;for(;this.length>=0&&!this.done;e++){const n=await this[e];if(!this.done&&await t(n,e,this))return n}for await(const n of this)if(await t(n,e++,this))return n},n.findIndex=async function(t){let e=0;for(;this.length>=0&&!this.done;e++){const n=await this[e];if(!this.done&&await t(n,e,this))return e}for await(const n of this){if(await t(n,e,this))return e;e++}},n.forEach=async function(t){for(let e=0;this.length>=0&&!this.done;e++){const n=await this[e];this.done||await t(n,e,this)}for await(const e of this)await t(e,this.length,this);return this.length},n.includes=async function(t){let e=0;for(;this.length>=0&&!this.done;e++){const n=await this[e];if(!this.done&&n===t)return!0}for await(const e of this)if(e===t)return!0;return!1},n.indexOf=async function(t){let e=0;for(;this.length>=0&&!this.done;e++){const n=await this[e];if(!this.done&&n===t)return e}for await(const n of this){if(n===t)return e;e++}return-1},n.keys=function(){const t=this;let e=async function*(){let e=0;for(;e<t.length;e++)yield e;for await(const n of t)yield e,e++};return(e=enhanceGenerator(e))()},n.lastIndexOf=async function(t){let e=0,n=-1;for(;this.length>=0&&!this.done;e++){const i=await this[e];this.done||i!==t||(n=e)}for await(const i of this)i===t&&(n=e),e++;return n},n.map=async function(t){const e=[];let n=0;for(;this.length>=0&&!this.done;n++){const i=await this[n];this.done||e.push(await t(i,n,this))}for await(const i of this)e.push(await t(i,n++,this));return e},n.reduce=async function(t,e){let n=void 0!==e,i=0;for(;this.length>=0&&!this.done;i++){const s=await this[i];this.done||(n?e=await t(e,s,i,this):(e=s,n=!0))}for await(const s of this)n?e=await t(e,s,i++,this):(e=s,n=!0);return e},n.reverse=function(){const t=this;let e=async function*(){const e=[];for(;t.length>=0&&!t.done;i++){const n=await t[i];t.done||e.unshift(n)}for await(const n of t)e.unshift(n);for(const t of e)yield t};return(e=enhanceGenerator(e))()},n.sort=function(t){const e=this;let n=async function*(){const n=[];for(;e.length>=0&&!e.done;i++){const t=await e[i];e.done||n.push(t)}for await(const t of e)n.push(t);n.sort(t);for(const t of n)yield t};return(n=enhanceGenerator(n))()},n.slice=function(t=0,e){const n=this;let i=async function*(){let i=0;for(;n.length>=0&&!n.done;i++){const s=await n[i];if(i<t)i++;else{if(i===e)return;i++,yield s}}for await(const s of n)if(i<t)i++;else{if(i===e)return;i++,yield s}};return(i=s(i))()},n.some=async function(t){let e=0;this.length;for(;this.length>=0&&!this.done;e++){const n=await this[e];if(!this.done&&await t(n,e,this))return!0}for await(const n of this)if(await t(n,e++,this))return!0},n.values=async function(){const t=[];for(;this.length>=0&&!this.done;i++){const e=await this[i];if(!this.done)if(e&&"object"==typeof e&&e instanceof Edge){let n=e._value;isSoul(n)?void 0!==(n=await e.db.getObject(n))&&t.push(n):t.push(n)}else void 0!==e&&t.push(e)}for await(const e of this)if(e&&"object"==typeof e&&e instanceof Edge){let n=e._value;isSoul(n)?void 0!==(n=await e.db.getObject(n))&&t.push(n):t.push(n)}else void 0!==e&&t.push(e);return t},n.withMemory=function(){Object.defineProperty(this,"length",{get:function(){return t.length}});const t=[];return new Proxy(this,{get(e,n){const i=e[n];if("next"===n)return async function(){const n=await i.call(e.generator);return n.done?e.done=!0:t.push(n.value),n};if("string"==typeof n||"number"==typeof n){const i=parseInt(n);if(!isNaN(i)){if(i<t.length)return t[i];let n,s=i-t.length+1;for(;s--;)n=e.next().then(n=>(n.done?e.done=!0:t.push(n.value),n.value));return n}}return i}})}):(n.every=function(t){let e=0;for(const n of this)if(add(this,n),!t(n,e++,this))return 0;return e},n.find=function(t){let e=0;for(const n of this)if(t(n,e++,this))return n},n.findIndex=function(t){let e=0;for(const n of this){if(add(this,n),t(n,e,this))return e;e++}},n.forEach=function(t){let e=0;for(const n of this)add(this,n),t(n,e++,this);return e},n.includes=function(t){for(const e of this)if(add(this,e),e===t)return!0;return!1},n.indexOf=function(t){let e=0;for(const n of this){if(add(this,n),n===t)return e;e++}return-1},n.keys=function(){const t=this;let e=function*(){let e=0;for(const n of t)add(this,n),yield e,e++};return(e=enhanceGenerator(e))()},n.lastIndexOf=function(t){let e=0,n=-1;for(const i of this)add(this,i),i===t&&(n=e),e++;return n},n.map=function(t){const e=[];let n=0;for(const i of this)add(this,i),e.push(t(i,n++,this));return e},n.reduce=function(t,e){let n=void 0!==e,i=0;for(const s of this)add(this,s),n?e=t(e,s,i++,this):(e=s,n=!0);return e},n.reverse=function(){const t=this;let e=function*(){const e=[];for(const n of t)add(t,n),e.unshift(n);this.values&&this.values.reverse();for(const t of e)yield t};return(e=enhanceGenerator(e))()},n.sort=function(t){const e=this;let n=function*(){const n=[];for(const t of e)add(this,t),n.push(t);this.values&&this.values.sort(),n.sort(t);for(const t of n)yield t};return(n=enhanceGenerator(n))()},n.slice=function(t=0,e){const n=this;let i=function*(){let i=0;for(const s of n)if(add(n,s),i<t)i++;else{if(i===e)return;i++,yield s}};return(i=enhanceGenerator(i))()},n.some=function(t){let e=0;for(const n of this)if(t(n,e++,this))return!0},n.values=function(){const t=[];for(const e of this)if(add(this,e),e&&"object"==typeof e&&e instanceof Edge){let n=e._value;isSoul(n)?void 0!==(n=e.db.getObject(n))&&t.push(n):t.push(n)}else void 0!==e&&t.push(e);return t},n.withMemory=function(){Object.defineProperty(this,"length",{get:function(){return t.length}});const t=[];return new Proxy(this,{get(e,n){const i=e[n];if("next"===n)return function(){const n=i.call(e.generator);return n.done?this.done=!0:t.push(n.value),n};if("string"==typeof n||"number"==typeof n){const i=parseInt(n);if(!isNaN(i)){if(i<t.length)return t[i];let n=i-t.length+1,s={};for(;n--;){if((s=e.generator.next()).done)return this.done=!0,s.value;t.push(s.value)}return s.value}}return i}})}),new Proxy(t,{apply(t,e,n){const i=t.call(e,...n),s=i.next;let r=i;return i.next=function(){return r===i?s.call(i):r.next()},Object.defineProperty(r,"reset",{enumerable:!1,value:()=>{r=t.call(e,...n),Object.defineProperty(t,"generator",{enumerable:!1,configurable:!0,value:r}),delete i.done}}),r}})}function r(t,e,{all:n}={}){for(const i of e){const e=s(t[i]);t[i]=function(...t){const i=e.call(this,...t);if(n)for(const t of n)i[t.name]=async function(...e){let n=[];for await(const s of i){const i=await s[t.name].call(s,...e);void 0!==i&&n.push(i)}return 0===n.length?void 0:1===n.length?n[0]:n};return i}}}async function o(t,e,n=!0){const i=t.db.options.storage,s=`${"/"===t.path?t.path:t.path+"/"}${e}`;let r=t.db.cache.getItem(s);if(r)return r;const o=await i.getItem(s);if(o)r=t.db.Edge("string"==typeof o?JSON.parse(o):o);else{if(!n)return null;r=t.db.Edge({path:s})}return r}function a(t,...e){const n=(t,e,i)=>{if(e instanceof Date)return e;for(const s in e){const r=e[s],o=typeof r,a=t[s];a!==r&&void 0!==a&&(i[s]=a),r&&"object"===o?(t[s]&&"object"==typeof t[s]||(t[s]=Array.isArray(r)?[]:{}),t[s]=n(t[s],r,i[s]={})):t[s]=r}return t},i={};for(const s of e)n(t,s,i);if(Object.keys(i).length>0)return i}function c(t){const e={};return a(e,t),e}function u(t){if("string"==typeof t){const e=t.split("@");return 2===e.length&&""!==e[0]&&("Date"===e[0]&&!isNaN(parseInt(e[1]))||21===e[1].length)}return!1}n.r(e);class f{constructor(t,e,n){if(e||(e={path:"/"}),Object.assign(this,e),this.path||(this.path="/"),!n){const e=t.cache.getItem(this.path);if(e)return e}this.edges||(this.edges={}),this.acls||(this.acls={r:{a:{},d:{}},w:{a:{},d:{}}}),Object.defineProperty(this,"db",{enumerable:!1,configurable:!1,writable:!1,value:t}),r(this,["get"],{all:[this.merge,this.value,this.on,this.secure]}),n||(this.dirty=!0,t.cache.setItem(this.path,this))}async aclRead(t){const e=this.acls,n=await this.db.options.authenticate();if(e.r.a[n]||e.r.a["*"]&&!e.r.d[n]||0===Object.keys(e.r.a).length&&0===Object.keys(e.r.d).length)return t}async aclWrite(t,e){const n=this.acls,i=await this.db.options.authenticate();if(n.w.a[i]||n.w.a["*"]&&!n.w.d[i]||0===Object.keys(n.w.a).length&&0===Object.keys(n.w.d).length)return t;if(void 0===e){const t=new Error(`Write access denied: ${this.path}`);if(!this.db.options.onError)throw t;this.db.options.onError(t)}return e}async add(t,e){const n=Array.isArray(this._value)?this._value.slice():this._value;Array.isArray(this._value)||(void 0===this._value?this._value=[]:this._value=[this._value]);const i=this._value.length;return this._value.some(e=>deepEqual(e,t))||this._value.push(t),this.onchange&&this._value.length!==i&&(this._value=await this.callbacks(this.onchange,this._value,n)),await this.save(e),this}async callback(t,e,n){if(t)for(const i of t){const t=await i.call(this,e,n);if(void 0===t)break;e=t}return e}compile(t){if("string"==typeof t){const e=t.split(":");let n=t,i=e[0].trim();if("*"===i)n={key:()=>!0};else if("("===i[0]||0===i.indexOf("function "))n={key:Function(`return ${i}`).call(this)};else for(const t of["<=","<","===","==","!==","!=",">=",">"])if(0===i.indexOf(t)){n={key:Function(`return value => value ${i}`).call(this)};break}if(1===e.length)return n;if("object"!=typeof n&&(n={key:e[0]}),0===(i=e[1].trim()).indexOf("=>"))return n.test=Function(`return ${e[0]} => ${e[0]}${i}`).call(this),n;if("("===i[0]||0===i.indexOf("function "))return n.test=Function(`return ${i}`).call(this),n;for(const t of["<=","<","===","==","!==","!=",">=",">"])if(0===i.indexOf(t))return n.test=Function(`return value => value ${i}`).call(this),n;return n.test=Function("return value => value===value").call(this),n}return t}async delete(t={}){return delete this._value,await this.save(t),this}get key(){return this.path.split("/").pop()}async merge(t,e){return this.value(t,!0,e)}on(t){for(const e in t)this["on"+e]||Object.defineProperty(this,"on"+e,{enumerable:!1,configurable:!0,writable:!0,value:new Set}),this["on"+e].add(t[e]);return this}off(t){for(const e in t)this["on"+e]&&this["on"+e].delete(t[e]);return this}once(t,e={wait:0}){return setTimeout(t,e.wait,this._value,this),this}async put(t,{indexDates:e,expireAt:n,atomic:i,indexAllObjects:s}=this.db.options){if(t&&"object"==typeof t&&s&&(t=await this.db.putItem(t,!0,{indexDates:e,expireAt:n,atomic:i})),(t&&"object"==typeof t&&t["#"]?t["#"]:t)!==this._value){if(s){const e=u(this._value)?await this.db.getObject(this._value,{read:!0}):this._value;deepEqual(t,e)||(t=await this.callback(this.onchange,t,e))}else t=await this.callback(this.onchange,t,this._value);this._value=t&&"object"==typeof t&&t["#"]?t["#"]:t,this.dirty=!0,await this.save()}return t}async parent(t){const e=t?await this.db.options.storage.getItem(this.parentKey):this.db.cache.getItem(this.parentKey)||await this.db.options.storage.getItem(this.parentKey);if(e)return this.db.Edge("string"==typeof e?JSON.parse(e):e,t)}async patch(t,{indexDates:e,indexAllObjects:n,expireAt:i,atomic:s}=this.db.options){if(t&&"object"==typeof t){let r,o,f=u(this._value)?await this.db.getObject(this._value):this._value;if(f&&"object"==typeof f&&(o=c(f),f._&&this.db.bless(o,f._.atomic,f._),r=a(o,t)),r){const r=f||(Array.isArray(t)?[]:{});f=c(f),o._&&this.db.bless(f,o._.atomic,o._,i),a(r,t),(t=await this.callback(this.onchange,r,f))._&&t._.version&&this.db.version(t,{expireAt:i}),u(this._value)&&n&&(t=await this.db.putItem(t,t._||!1,{indexDates:e,expireAt:i,atomic:s}))}}return this._value=t&&"object"==typeof t&&t["#"]?t["#"]:t,this.dirty=!0,await this.save(),t}get parentKey(){const t=this.path.split("/");return t.pop(),t.length>0?t.join("/"):"/"}async removeEdge(t){if(delete this.edges[t],await this.save(),await this.db.options.storage.removeItem(this.path+"/"+t),0===Object.keys(this.edges).length){const t=await this.parent();t&&await t.removeEdge(this.key)}}async save({force:t,callback:e}={}){if(!t&&!this.dirty)return this;let n=this;const i=await n.parent(),s=await n.parent(!0);if(s&&!s.edges[n.key]&&(n=await n.callback(i.onextend,this)),!n)return;delete n.dirty;let r=n.db.options.storage.setItem(n.path,JSON.stringify(n));return r&&"object"==typeof r&&r instanceof Promise||(r=Promise.resolve()),r.catch(t=>{throw n.dirty=!0,t}),e&&(r.then(()=>e({ok:!0})),r.catch(t=>e({err:t}))),await r,i&&(i.edges[n.key]=!0,await i.save({force:t,callback:e})),this}async secure({read:t,write:e,expires:n},...i){return i.forEach(i=>{const s="string"==typeof i?i:i["#"];t?(delete this.acls.r.d[s],this.acls.r.a[s]=!(n&&"object"==typeof n&&n instanceof Date)||n.getTime()):(delete this.acls.r.a[s],this.acls.r.d[s]=!(n&&"object"==typeof n&&n instanceof Date)||n.getTime()),e?(delete this.acls.w.d[s],this.acls.w.a[s]=!(n&&"object"==typeof n&&n instanceof Date)||n.getTime()):(delete this.acls.w.a[s],this.acls.w.d[s]=!(n&&"object"==typeof n&&n instanceof Date)||n.getTime())}),await this.save(),this}async value(t,e,{indexDates:n,indexAllObjects:i,expireAt:s,atomic:r}=this.db.options){return arguments.length>0?t=e&&t&&"object"==typeof t?await this.patch(t,{indexDates:n,indexAllObjects:i,expireAt:s,atomic:r}):await this.put(t,{indexDates:n,indexAllObjects:i,expireAt:s,atomic:r}):(u(t=this._value)&&(t=await this.db.getObject(t)),t=await this.callback(this.onget,t))}}async function*l(t,...e){async function*n(t,i){for await(const s of e[t]())(i=i.concat(s)).length===e.length+1?(yield i.slice(),i.pop()):t<e.length-1&&(yield*await n(t+1,i))}for await(const e of t())for await(const t of n(0,[e]))yield t}function h(t,e,n=1/0,i){if(t===e)return!0;const s=Array.isArray(t),r=Array.isArray(e);if(s&&r){const o=t.length;if(o!=e.length)return!1;if(i){intersection(flattenDeep(s),flattenDeep(r));return interesect.length===s.length}for(let i=0;i<o;i++)if(!h(t[i],e[i],n))return!1;return!0}if(s!=r)return!1;const o=t instanceof Date,a=e instanceof Date;if(o!=a)return!1;if(o&&a)return t.getTime()===e.getTime();const c=t instanceof RegExp,u=e instanceof RegExp;if(c!=u)return!1;if(c&&u)return t.toString()===e.toString();if(t instanceof Object&&e instanceof Object){if(0===n)return!0;const i=Object.keys(t),s=i.length;if(s!==Object.keys(e).length)return!1;for(let t=0;t<s;t++)if(void 0===e[i[t]])return!1;for(let r=0;r<s;r++){const s=i[r];if(!h(t[s],e[s],--n))return!1}return!0}return!1}f.prototype.get=function*(){};class d{constructor(t=0,e=0,n=0){Object.defineProperty(this,"latitude",{enumerable:!0,value:t}),Object.defineProperty(this,"longitude",{enumerable:!0,value:e}),Object.defineProperty(this,"altitude",{enumerable:!0,value:n}),d.singletons[`${t};${e};${n}`]=this}}function p(t=21){"undefined"==typeof self||self;const e=n(1),i=e.getRandomValues?e.getRandomValues(new Uint8Array(t)):e.randomFillSync(new Uint8Array(t));let s="";for(;0<t--;)s+="_~getRandomVcryp0123456789bfhijklqsuvwxzABCDEFGHIJKLMNOPQSTUWXYZ"[63&i[t]];return s}d.singletons={},d.dereference=((t,e="@")=>{const[n,i]=t.split(e);return d.singletons[i]||new d(i.split(";").slice(1))}),d.generateId=function(t,e){return`${e}${t.latitude};${t.longitude};${t.altitude}`},d.valueKeyed=!0;class g{constructor(t=1e5,e=.1){this.maxCount=t,this.step=e,this.data={},this.usage={},this.count=0}setItem(t,e){let n=this.data[t];n?(delete this.usage[n.count].data[t],this.usage[n.count].count--,this.usage[n.count].count<=0&&delete this.usage[n.count]):(n=this.data[t]={count:0},this.count++),n.count++,n.value=e,this.usage[n.count]||(this.usage[n.count]={count:0,data:{}}),this.usage[n.count].count++,this.usage[n.count].data[t]=n;const i=this.step<1&&this.step>0?this.maxCount*this.step:this.maxCount-Math.min(this.maxCount,Math.max(1,this.step));if(this.count>this.maxCount){const t=Object.keys(this.usage).sort((t,e)=>parseInt(t)-parseInt(e));for(const e of t){for(const t in this.usage[e])if(delete this.usage[e].data[t],this.usage[e].count--,this.usage[e].count<=0&&delete this.usage[e],delete this.data[t],this.count--,this.count<=0||this.count<i)break;if(this.count<=0||this.count<i)break}}return e}getItem(t){const e=this.data[t];if(e)return delete this.usage[e.count].data[t],this.usage[e.count].count--,this.usage[e.count].count<=0&&delete this.usage[e.count],e.count++,this.usage[e.count]||(this.usage[e.count]={count:0,data:{}}),this.usage[e.count].count++,this.usage[e.count].data[t]=e,e.value}removeItem(t){const e=this.data[t];return!!e&&(delete this.usage[e.count].data[t],this.usage[e.count].count--,this.usage[e.count].count<=0&&delete this.usage[e.count],delete this.data[t],this.count--,!0)}}function y(t){var e=(t=(t+"").toLowerCase().split("")).shift(),n={a:"",e:"",i:"",o:"",u:"",b:1,f:1,p:1,v:1,c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2,d:3,t:3,l:4,m:5,n:5,r:6};return(e+t.map(function(t){return n[t]}).filter(function(t,i,s){return 0===i?t!==n[e]:t!==s[i-1]}).join("")+"000").slice(0,4).toUpperCase()}const b={$(t,e){if("function"!=typeof(e="function"==typeof e?e:!this.db.options.inline||new Function("return "+e)()))return;const n=JSON.stringify(t),i=e.call(void 0,t);if(JSON.stringify(t)!==n)throw new Error("function call by $test has illegal side effect");return i},$and:(t,e)=>Object.keys(e).every(n=>((t,e,n)=>b[e](t,n))(t,n,e[n])),$or:(t,e)=>Object.keys(e).some(n=>((t,e,n)=>b[e](t,n))(t,n,e[n])),$xor:(t,e)=>1===Object.keys(e).reduce((n,i)=>(((t,e,n)=>b[e](t,n))(t,i,e[i])&&++n,n),0),$not:(t,e)=>!Object.keys(e).every(n=>((t,e,n)=>b[e](t,n))(t,n,e[n])),$lt:(t,e)=>t<e,$lte:(t,e)=>t<=e,$eq(t,e,n,i){deepEqual(test,value,n,i)},$eeq:(t,e)=>t===e,$eq:(t,e)=>t==e,$neq:(t,e)=>t!=e,$neeq:(t,e)=>t!==e,$gte:(t,e)=>t>=e,$gt:(t,e)=>t>e,$between:(t,e,n,i=!0)=>i?t>=e&&t<=n||t>=n&&t<=e:t>e&&t<n||t>n&&t<e,$outside:(t,e,n)=>!b.$between(t,e,n,!0),$in:(t,e)=>e.includes(t),$nin:(t,e)=>!e.includes(t),$includes:(t,e)=>t.includes(e),$excludes:(t,e)=>!t.includes(e),$intersects:(t,e)=>Array.isArray(t)&&Array.isArray(e)&&intersection(t,e).length>0,$disjoint(t,e){return!this.$intersects(t,e)},$matches:(t,e,n)=>(e=e&&"object"==typeof e&&e instanceof RegExp?e:new RegExp(e,n)).test(t),$typeof:(t,e)=>typeof t===e,$instanceof(t,e){if(u(t)){const t=n.split("@")[0],e=this.db.schema[t]?this.db.schema[t].ctor:null,n=e?Object.create(e.prototype):n}return e="string"==typeof e&&this.db.schema[e]?this.db.schema[e].ctor:e,t&&"object"==typeof t&&e&&"function"==typeof e&&t instanceof e},async $isArray(){const t=[];for(const e in this.edges)0===e.indexOf("Array@")&&u(e)&&t.push(await o(this,e,!1));if(t.length>0)return this.yield=t,!0},$isCreditCard:t=>/^(?:4[0-9]{12}(?:[0-9]{3})?|(?:5[1-5][0-9]{2}|222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}|3[47][0-9]{13}| 3(?:0[0-5]|[68][0-9])[0-9]{11}|6(?:011|5[0-9]{2})[0-9]{12}|(?:2131|1800|35\d{3})\d{11})$/m.test(t)&&validateLuhn(t),$isEmail:t=>!/(\.{2}|-{2}|_{2})/.test(t)&&/^[a-z0-9][a-z0-9-_\.]+@[a-z0-9][a-z0-9-]+[a-z0-9]\.[a-z]{2,10}(?:\.[a-z]{2,10})?$/i.test(t),$isEven:t=>t%2==0,$isIPAddress:t=>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/m.test(t),$isNaN:t=>isNaN(t),$isOdd:t=>t%2!=0,$isSSN:t=>/^\d{3}-?\d{2}-?\d{4}$/.test(t),$echoes:(t,e)=>y(t)===y(e),async $search(t,e){const n=arguments[2],i=await o(this,"$fulltext");if(i){this.yield=[];for(let t in i.edges){const s=JSON.parse(t);if(n.stems.includes(s)||n.trigrams.includes(s)){const n=await o(i,t);if(n&&(this.yield.push(n),e.length-2==="/"&&e.length-1==="s"))break}}return this.yield.length>0}return!!n.stems.some(t=>e.includes(t))||(e=e.replace(/\s/g,""),!!n.trigrams.some(t=>e.includes(t))||void 0)},$self(t){return t(this._value)}};for(const t of["date","day","fullYear","hours","milliseconds","minutes","month","seconds","time","UTCDate","UTCDay","UTCFullYear","UTCHours","UTCSeconds","UTCMilliseconds","UTCMinutes","UTCMonth","year"]){const e=`get${t[0].toUpperCase()}${t.substring(1)}`;b["$"+t]=Function(`return function ${"$"+t}(a,b) { \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tif(typeof(a)==="number") { a = new Date(a); } if(typeof(b)==="number") { b = new Date(b); }; \n\t                                if(typeof(a)==="object" && a instanceof Date && typeof(b)==="object" && b instanceof Date) return a.${e}()===b.${e}(); }`)()}function m(t,e){Object.getPrototypeOf(t)!==Object.getPrototypeOf(async()=>{})&&(e[t.name]=async function(...e){return new Promise((n,i)=>t.call(this,...e,(t,e)=>{t?i(t):n(e)}))})}var w="y".charCodeAt(0),v={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},j={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},O=new RegExp("^([^aeiou][^aeiouy]*)?([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)"),x=new RegExp("^([^aeiou][^aeiouy]*)?([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)([aeiouy][aeiou]*)?$"),$=new RegExp("^([^aeiou][^aeiouy]*)?(([aeiouy][aeiou]*)([^aeiou][^aeiouy]*)){2,}"),k=new RegExp("^([^aeiou][^aeiouy]*)?[aeiouy]"),A=new RegExp("^([^aeiou][^aeiouy]*)[aeiouy][^aeiouwxy]$"),_=/ll$/,I=/^(.+?)e$/,D=/^(.+?)y$/,E=/^(.+?(s|t))(ion)$/,S=/^(.+?)(ed|ing)$/,P=/(at|bl|iz)$/,C=/^(.+?)eed$/,T=/^.+?[^s]s$/,q=/^.+?(ss|i)es$/,N=/([^aeiouylsz])\1$/,R=new RegExp("^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$"),z=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,G=new RegExp("^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$");function F(t){var e,n;return(t=String(t).toLowerCase()).length<3?t:(t.charCodeAt(0)===w&&(e=!0,t="Y"+t.substr(1)),q.test(t)?t=t.substr(0,t.length-2):T.test(t)&&(t=t.substr(0,t.length-1)),(n=C.exec(t))?O.test(n[1])&&(t=t.substr(0,t.length-1)):(n=S.exec(t))&&k.test(n[1])&&(t=n[1],P.test(t)?t+="e":N.test(t)?t=t.substr(0,t.length-1):A.test(t)&&(t+="e")),(n=D.exec(t))&&k.test(n[1])&&(t=n[1]+"i"),(n=R.exec(t))&&O.test(n[1])&&(t=n[1]+v[n[2]]),(n=z.exec(t))&&O.test(n[1])&&(t=n[1]+j[n[2]]),(n=G.exec(t))?$.test(n[1])&&(t=n[1]):(n=E.exec(t))&&$.test(n[1])&&(t=n[1]),(n=I.exec(t))&&($.test(n[1])||x.test(n[1])&&!A.test(n[1]))&&(t=n[1]),_.test(t)&&$.test(t)&&(t=t.substr(0,t.length-1)),e&&(t="y"+t.substr(1)),t)}Array.dereference=(t=>[]),Array.generateId=function(t,e,n=p()){return`${e}${n}`},Boolean.generateId=function(t){return t},Date.dereference=((t,e="@")=>{const[n,i]=t.split(e);return new Date(parseInt(i))}),Date.generateId=function(t,e){return`${e}${t.getTime()}`},Function.dereference=((t,e="@")=>{const[n,i]=t.split(e);return Function(`return ${i}`)()}),Function.generateId=function(t,e){return`${e}${t}`},Number.dereference=((t,e="@")=>{const n=t.split(e);return 1===n.length?JSON.parse(n[0]):JSON.parse(n[1])}),Number.generateId=function(t,e){return t===1/0||t===-1/0||isNaN(t)?`${e}${t}`:t},String.generateId=function(t){return t},Object.generateId=function(t,e,n=p()){return`${e}${n}`};const J={Date:Date,Function:Function,Object:Object,Array:Array},U={},M={dereference(t,{key:e}={}){e||(e=U.key);const n=typeof t;if("string"===n){const[n,i]=Object.entries(J).filter(([e,n])=>t.startsWith(`${e}${U.prefixDelimiter}`))[0]||[];if(!i)return t;let s;if(i.dereference){if((s=i.dereference(t,U.prefixDelimiter))&&"object"!=typeof s)return s}else s=Object.create(i.prototype);if(Object.defineProperty(s,e,{enumerable:!1,configurable:!0,writable:!0,value:t}),!i.valueKeyed)return s;t=this.dereference(s,U.prefixDelimiter)}else Array.isArray(t)?t.forEach((t,e,n)=>n[e]=this.dereference(t,U.prefixDelimiter)):t&&"object"===n&&Object.keys(t).forEach(n=>{n===e||(t[n]=this.dereference(t[n],U.prefixDelimiter))});return t},generateId(t,{key:e,keyGenerator:n}={}){if(null==t)return t;e||(e=U.key),n||(n=U.keyGenerator);let i=t.constructor.generateId,s=U.prefixGenerator(t)+U.prefixDelimiter;return i?i(t,s,n?n():void 0):t},getId(t,e,{key:n,keyGenerator:i}){return t[n]?t[n]:e?this.generateId(t,{key:n,keyGenerator:i}):void 0},isValueKeyed(t,e=U.key){const n=t[e];return!!t.constructor.valueKeyed||!!(n&&this.generateId(t)===n||this.generateId(t)===this.dereference(this.generateId(t))[e])&&(Object.defineProperty(t.constructor,"valueKeyed",{enumerable:!1,configurable:!0,writable:!1,value:!0}),!0)},setOptions({key:t,generateId:e,prefixDelimiter:n,prefixGenerator:i}={}){!t||(U.key=t),!e||(U.generateId=e),!n||(U.prefixDelimiter=n),!i||(U.prefixGenerator=i),Object.getOwnPropertyDescriptor(Object,"generateId")||Object.defineProperty(Object,"generateId",{configurable:!0,writable:!0,value:e})},reference(t,{key:e,keyGenerator:n,references:i=[]}={}){if(e||(e=U.key),n||(keyGen=U.keyGenerator),t&&"object"===typeof t){if([Number,String,Boolean].some(e=>t instanceof e))return[t.valueOf()];if(J[t.constructor.name]||this.register(t.constructor),!t[e]){const i=this.generateId(t,{key:e,keyGenerator:n});Object.defineProperty(t,e,{enumerable:!1,configurable:!0,writable:!0,value:i})}return i[t[e]]||(i[t[e]]=t,i.push(t)),Object.keys(t).forEach(e=>{t[e]&&"object"==typeof t[e]&&(t[e]=this.reference(t[e],{key:e,generateId:generateId,references:i})[0])}),i}return[t]},register(t,e=t.name){J[e]=t}};function L(t){return t.replace(/[<>"'\{\}\[\]\(\)\-\=\+\*\~\n\t]/g,"").toLowerCase().split(" ")}function H(t){const e=[],n=Array.isArray(t)?t.join(""):t+"";for(let t=0;t<n.length-2;t++)e.push(n.substring(t,t+3));return e}M.setOptions({key:"#",keyGenerator:void 0,prefixDelimiter:"@",prefixGenerator:function(t){return t.constructor.name}});class K{constructor(t){this.db=t}from(t){return this.source=t,this}where(t){if("function"==typeof this.source){return(async()=>{let e=0;return(t=Object.assign({},t)).$self=Object.assign({},t.$self,{$instanceof:this.source}),await this.db.match(t).forEach(t=>{this.db.removeItem(t),e++}),e})()}Object.keys(t).forEach(t=>{})}}class W{constructor(t,e){this.db=t,this.objects=e}into(t){this.objects.forEach((e,n,i)=>{const s=Object.create(t.prototype);i[n]=Object.assign(s,e)});return(async()=>{let t=0;for(const e of this.objects)await this.db.putItem(e),t++;return t})()}}const V=t=>{const e=Object.getPrototypeOf(t);return e===Object.getPrototypeOf(function*(){})||e===Object.getPrototypeOf(async function*(){})},B=(t,e)=>Function("f,",`return function ${e}(...args) { return f.call(this,...args); }`)(t),Y=(t,e)=>{let n={};return Object.keys(t).forEach(i=>{t[i]&&"object"==typeof t[i]?Object.keys(t[i]).forEach(s=>{e.includes(s)?n[i]="$true!":n[i]=Y(t[i],e)}):n[i]=t[i]}),n},Q=(t,e,n={},i=n,s=[])=>{let r;return Object.keys(t).forEach(o=>{const a=t[o],c=typeof a,u=s[s.length-1];if("$"===a){if(e[u]&&void 0!==e[u][o]){const t=s.slice(0,s.length-1);let n,r,a,c=i;for(;n=t.shift();)"$"===n[0]&&(r=c,a=n),c=c[n];r[a]=e[u][o],delete r[u]}r=n}else a&&"object"===c&&(s.push(o),Q(a,e,n[o]={},i,s)?r=!0:delete n[o],s.pop(o))}),r},X=function*(t){for(var e=[],n=t.length-1,i=[],s=t.length;s--;)i[s]=t[s].length;for(const s of function*s(r){var o=t[r],a=i[r];if(r==n)for(var c=0;c<a;++c)e[r]=o[c],yield e;else for(c=0;c<a;++c)e[r]=o[c],yield*s(r+1);e.pop()}(0))yield s};M.register(d);const Z={Array:{ctor:Array},Date:{ctor:Date},Function:{ctor:Function},Object:{ctor:Object},GeoPoint:{ctor:d}},tt=new class{constructor(){this.data={}}clear(){this.data={}}getItem(t){const e=this.data[t];return void 0===e?null:e}removeItem(t){delete this.data[t]}setItem(t,e){return this.data[t]=e}};class et{static get memoryStorage(){return tt}static get predicates(){return b}constructor(t={}){r(this,["get","match","matchObjects","matchPath"],{all:[f.prototype.value,f.prototype.on,f.prototype.secure,f.prototype.patch,f.prototype.put]}),this.options=t=Object.assign({},t),t.authenticate||(t.authenticate=(()=>!0));let e=t.storage;e||(e=t.storage=tt),e=t.storage=function(t,e={}){if(!t)throw new Error("Storage option not provided");const n={};t:for(const i of["get","set","remove"])if("function"!=typeof t[`${i}Item`]){if("function"!=typeof t[i]){if("remove"===i)for(const s of["del","delete"])if("function"==typeof t[s]){e.promisify&&m(t[s],t),t[`${i}Item`]=async function(...e){return t[s].call(this,...e)},n[`${i}Item`]=s;break t}throw new Error(`Missing ${i} or ${i}Item`)}e.promisify&&m(t[i],t),t[`${i}Item`]=async function(...e){return await t[i].call(this,...e)},n[`${i}Item`]=i}else e.promisify&&m(t[`${i}Item`],t);return e.workerArgumentsList&&void 0!==window.Worker&&t!==tt&&t!==localStorage?new WorkerProxy("../worker-proxy.js",t,{argumentList:e.workerArgumentList,instanceVariable:e.workerInstanceVariable,cname:e.workerName,propertyMap:n}):t}(e,this.options),this.schema=Object.assign({},Z,t.schema),this.predicates=Object.assign({},b,t.predicates),this.cache=new g,this.Edge=((t={},e)=>new f(this,t,e)),t.onready&&(this.onready=t.onready),this.initialized=new Promise(async e=>{const n=this.options.storage;t.clear&&await this.clear(),t.authenticate&&await t.authenticate.call(this),await n.getItem("/")||await n.setItem("/",JSON.stringify(this.Edge())),await this.secure(),this.expire(),t.listen&&this.listen(t.listen),e(),this.onready&&this.onready.call(this)})}arbitrate(t,e){const n=t._,i=n.modifiedAt.getTime(),s=n.createdAt.getTime(),r=e._,o=r.modifiedAt.getTime(),a=r.createdAt.getTime(),c=i-Date.now(),u=Math.max(n.version,r.version);if(!h(t,e)||i!==o||n.version!==r.version||n.createdAt!==r.createdAt)if(c>0)setTimeout(()=>this.putItem(t),c);else if(!(i<o)){if(i>o)return n.version=u,t;if(n.version===r.version&&i===o){if(s>a)return t;if(a>s)return;return n["#"]>=r["#"]?(n.version=u,t):void 0}}}async bless(t,e=(t._?t._.atomic:void 0),n=t._,i){n&&n["#"]===t["#"]||(n||(n={}),t._||Object.defineProperty(t,"_",{enumerable:!1,configurable:!1,writable:!0,value:n}),n["#"]||(n["#"]=M.generateId(t)),e&&(n.atomic=!0),i&&(n.expireAt=i),Object.defineProperty(t,"#",{enumerable:!1,configurable:!0,get:()=>n["#"],set(){}}),n.version||this.version(t,{atomic:!0}));for(const t in n)if("#"!==t){const e=n[t];u(e)&&(n[t]=await this.getObject(e))}if(!e)for(const e in t)"_"===e||!t[e]||"object"!=typeof t[e]||await this.bless(t[e]);return t}async clear(){const t=this.options.storage,e=t.clear||t.flush||t.flushdb||t.destroy||(()=>!0);await e.call(t),await t.setItem("/",JSON.stringify(this.Edge()))}compile(t,{indexDates:e,inline:n}={}){if("*"===t)return()=>!0;const i=typeof t;if("string"===i){if(n&&t.indexOf("=>")>1)try{const e=Function("return "+t)(),n=typeof e;if("function"===n)return e;if("object"===n&&e instanceof RegExp)return t=>e.test(t)}catch(t){}return t}if(t&&"object"===i){if(t instanceof Date)return e?(s=t,"full"===e?{time:s.getTime(),day:s.getUTCDay(),date:s.getUTCDate(),hours:s.getUTCHours(),milliseconds:s.getUTCMilliseconds(),minutes:s.getUTCMinutes(),month:s.getUTCMonth(),seconds:s.getUTCSeconds(),year:s.getUTCFullYear()}:{time:s.getTime()}):"Date@"+t.getTime();const n=Object.keys(t),i=n.length>0&&"$"===n[0][0]?n[0]:null,r=this.predicates[i],o=t[i];let a;if("string"==typeof o&&"$true!"!==o&&((a={}).words=L(o),a.stems=a.words.map(t=>F(t)),a.trigrams=H(a.stems)),i&&r){if(n.length>1)throw new Error(`Property values can contain only one predicate test: ${JSON.stringify(n)}`);if(r.length<=2)return Function("test","arg","tokens",`return function ${i}(x) { return arg==="$true!" || test.bind(this)(x,arg,tokens); }`)(r,o,a);if(!Array.isArray(o))throw new Error(`Predicate ${i} expected array as argument and recieved ${o}`);return Function("test","arg",`return function ${i}(x) { return test.bind(this)(x,...arg); }`)(r,o)}}var s;return t}delete(){return new K(this)}expire(t){t||(t=this.options.expirationInterval);(async()=>{if(t>0){const e=Date.now();for await(const t of this.match({expireAt:{time:{$lte:e}}}))await this.removeItem(t["#"]);const n=Date.now()-e;n>=t?this.expire():setTimeout(()=>this.expire(),t-n)}})()}async*get(t){if(0===t.indexOf("http://")||0===t.indexOf("https://")){const e=(await fetch(t)).json();return void(e.edges&&"object"==typeof e.edges?(e.path=t,yield this.Edge(e)):yield this.Edge({path:t,value:e}))}const e=Array.isArray(t)?t:t.split("/");if(""===e[0]&&e.shift(),1===e.length&&u(e[0]))return void(yield{edges:{[e[0]]:!0}});const n=this.Edge();for await(const t of n.get(e.shift(),void 0,e))yield t}get GeoPoint(){return d}async getItem(t){const e=this.options.storage.getItem(t);if(null!=e)return await this.restore(JSON.parse(e))}async getObject(t,{partial:e,read:n,nocache:i}={}){if(!t)return;let s=M.dereference(t);if(M.isValueKeyed(s))return s;if(!n&&(s=this.cache.getItem(t)))return await this.restore(s,{partial:e,read:n});const r=await this.options.storage.getItem(t);if(r)return s=await this.restore("string"==typeof r?JSON.parse(r):r,{partial:e,read:n}),this.getObjectRemote(t,r._),i?s:this.cache.setItem(t,s);this.getObjectRemote(t)}async getObjectRemote(t,e){if(this.getObjectRemote.memo||(this.getObjectRemote.memo={}),!this.getObjectRemote.memo[t]){this.getObjectRemote.memo[t]=!0;for(const e in this.options.peers)fetch(`${e}/${t}`).then(async t=>{t.ok?console.log(await t.json()):console.log(await t.text())}).catch(t=>console.log(t)).finally(()=>{this.getObjectRemote.memo[t]=null})}}getPaths(t,{indexDates:e}={},n,i=[],s={},r,o){const a=this.options,c=typeof t;if("string"===c)if(u(t))n.push(t),i.push(n);else{const e=n.slice();if(n.push(`"${t}"`),i.push(n),(!r||a.explicitSearchable&&r.searchable[o]||!a.explicitSearchable&&!1!==r.searchable[o])&&t.indexOf(" ")>=0){const n=L(t).map(t=>F(t)),r=H(n);e.push("$fulltext"),n.forEach(t=>{const n=e.slice();n.push(`"${t}"`),n.push(s["#"]),i.push(n)}),r.forEach(t=>{const n=e.slice();n.push(`"${t}"`),n.push(s["#"]),i.push(n)})}}else if(t&&"object"===c){if(r=this.getSchema(t),n||(n=[t.constructor.name]),t["#"]&&i.length>0){const e=n.slice();e.push(t["#"]),i.push(e)}const s=Object.keys(t);for(const o of s)if(!r||a.explicitIndex&&r.index[o]||a.explicitSearchable&&r.searchable[o]||!a.explicitIndex&&!1!==r.index[o]){const s=n.slice(),a=this.compile(t[o],{indexDates:e,inline:this.options.inline}),c=typeof a;t[o]instanceof Date&&a&&"object"===c&&!(a instanceof Date)&&(a[`Date@${t[o].getTime()}`]=t["#"]),"$self"===o?s.push(a):(s.push(this.compile(o,{indexDates:e,inline:this.options.inline})),this.getPaths(a,{indexDates:e},s,i,t,r,o))}}else n.push(t),i.push(n);return i}getSchema(t){const e=t.constructor,n=e.name,i=this.schema[n],s=i&&i.schema?i.schema:e.schema;if(s)return s.ctor||(s.ctor=e),Object.assign({index:{},searchable:{},integrity:{},management:{},security:{},validation:{}},s)}async graph(t,{indexDates:e,leaf:n}={}){const i=this.Edge();for(let s of this.getPaths(t,{indexDates:e})){n&&s.push(n);s.slice();const t=s.shift();for await(const e of i.get(t,void 0,s))await e.save()}return await i.save(),t}insert(...t){return new W(this,t)}join(...t){const e=this,n=t.pop(),i=t;return s(async function*(){const t=[];for(const n of i)t.push(()=>e.match(n));for await(const e of l(...t))n(e)&&(yield e)})()}async*match(t,{partial:e,read:n}={}){const i=typeof t;if("string"===i)for await(const i of this.matchPath(t,{partial:e,read:n})){const s=await this.getObject(i,{partial:e?t:null,read:n});s&&(yield s)}else if(t&&"object"===i)for await(const i of this.matchObjects(t)){const s=await this.getObject(i,{partial:e?t:null,read:n});s&&(yield s)}}async*matchObjects(t){let e;for(let n of this.getPaths(t)){let t;if(await this.get(n).forEach(e=>{t||(t={}),Object.assign(t,e.edges)}),!t)return;if(e){let n={};for(const i in t)e[i]&&(n[i]=i);e=n}else e=t}for(const t in e)yield t}async*matchPath(t){let e;if(await this.get(t).forEach(t=>{e||(e={}),Object.assign(e,t.edges)}),e)for(const t in e)yield t}async putItem(t,e,{indexDates:n,expireAt:i,atomic:s=(t._?t._.atomic:void 0),source:r}=this.options){const o=t["#"];if(o){const n=await this.getObject(o,{read:!0,nocache:!0});if(n){if(!(t=this.arbitrate(t,n)))return;const r=a(n,t);if(r){this.bless(r,!0,n._);for(const e in t._)n._[e]=t._[e];t=n,await this.ungraph(r,{leaf:o})}e||this.version(t,{expireAt:i,atomic:s})}}return await this.saveObject(t,{indexDates:n,expireAt:i,atomic:s,source:r}),await this.graph(t,{indexDates:n,leaf:t["#"]})}async removeItem(t){if("string"==typeof t){if(!u(t))return void await this.options.storage.removeItem(t);t=await this.getObject(t)}t&&t["#"]&&(this.cache.removeItem(t["#"]),await this.options.storage.removeItem(t["#"]),await this.ungraph(t._,{indexDates:!0,leaf:t["#"]}),await this.ungraph(t,{leaf:t["#"]}))}async restore(t,{partial:e,read:n}={}){this.options.storage;if("string"==typeof t)return u(t)?this.getObject(t,{partial:e}):M.dereference(t);if(t&&"object"==typeof t&&t["#"]){const[i,s]=t["#"].split("@"),r="Array"===i?[]:"Date"===i?new Date(parseInt(s)):Object.create(this.schema[i].ctor.prototype),o=Object.keys(t);o.push("_");for(const s of o)if("_"===s){if(t._)for(const e in t._)"#"===e||(t._[e]=await this.restore(t._[e]));await this.bless(r,!!t._&&t._.atomic,t._)}else if("#"!==s&&(!e||void 0!==e[s])){let o=t[s];for await(const t of this.get(`${i}/${s}`))void 0!==(o=await t.aclRead(o))&&(o=await t.callback(t.onget,o));void 0!==o&&(r[s]=await this.restore(o,{partial:e,read:n}))}return r}return t}async saveObject(t,e={}){const{expireAt:n,atomic:i,source:s}=e,r=await this.serializable(t,{expireAt:n,atomic:i,save:!0,explode:!0});this.saveObjectRemote(r,{source:s})}async saveObjectRemote(t,{source:e}){const n=t["#"];for(const i in this.options.peers){if(0===i.indexOf(e))continue;const s=JSON.stringify(t);fetch(`${i}/${n}`,{method:"PUT",body:s,headers:{Accept:"application/json;charset=utf-8","Content-Length":s.length}}).then(async t=>{if(t.ok){const e=await t.text();e!==s&&console.log("New data",s,e)}else console.log(await t.text())}).catch(t=>console.log(t))}}async secure(t,{read:e,write:n,expires:i,authorized:s=[]}={}){if(!(arguments.length<2))return this.get(t).forEach(async t=>{t.unsecure=!0,t.secure({read:e,write:n,expires:i},...s)});for(const t in this.schema){const e=this.schema[t];if(e.secure)for(const n in e.secure)await this.secure(`${t}/${n}`,e.secure[n])}}select(...t){return function t(e,...n){const i=n.reduce((t,e)=>Object.assign(t,e),{});async function*r(){const t=[],s=Object.keys(r.queries);for(const e of s){const o=r.queries[e],a=[];t.push(a);for await(const t of o())if(t)if(n.length>0){const e={};Object.keys(t).forEach(n=>{const s=i[n];s&&Object.keys(s).forEach(i=>{const r=t[n][i],o="string"==typeof s[i]?s[i]:s[i].as||i;e[o]=null!=r?r:s[i].default})}),Object.keys(e).forEach(n=>{const i=e[n];"function"==typeof i&&(e[n]=i(Object.assign({},t,e)))}),1===s.length?yield e:a.push(e)}else 1===s.length?yield t:a.push(t)}if(s.length>1)for(const n of X(t)){const t=n.reduce((t,e)=>Object.assign(t,e),{}),i={};s.forEach(e=>{Q(r.where[e],t,i[e]={})||delete i[e]}),e.getPaths(i).every(e=>{e.shift();let n,i=e.pop(),s=t;for(;n=e.shift();)if("undefined"===(s=s[n]))return!1;return s===i||"function"==typeof i&&i(s)})&&(yield t)}}return r.queries={},r.from=((...n)=>{n.forEach(t=>{Array.isArray(t)||("object"==typeof t?Object.keys(t).forEach(e=>{r.queries[e]=t[e]}):r.queries[t.name]=t)}),Object.keys(r.queries).forEach(t=>{const n=r.queries[t];let i;V(n)?i=B(n,t):Array.isArray(n)?i=B(async function*(){for await(const t of n)yield t},t):"function"==typeof n&&((i=async function*(){for await(const t of e.get(`/${n.name}/#`))for(const n in t.edges)yield e.getObject(n)}).instanceOf=n),i&&(r.queries[t]=i)});const i=s(r);return i.groupBy=function(t){},i.where=function(t){const n=Object.keys(r.queries);r.where=t;for(const i of n)if(t[i]){const s=r.queries[i].instanceOf;r.queries[i]=async function*(){if(s)if(t[i].$self){const e=t[i].$self;t[i].$self={$and:{}},Object.assign(t[i].$self.$and,e,{$instanceof:cname})}else t[i].$self={$instanceof:s};for await(const s of e.match(Y(t[i],n)))yield{[i]:s}}}const i=this();return i.groupBy=(t=>{}),i},i.join=function(n){const i=this,r="select"===n.name?n:t(e).from(n),o=Object.keys(i.queries)[0],a=Object.keys(r.queries)[0];let c,u=async function*(){for await(const t of i())for await(const e of r()){let n={[o]:t,[a]:e},i=c?await c(n):n;i&&"object"==typeof i&&(yield Object.assign({},{[o]:i[o]},{[a]:i[a]}))}};return(u=s(u)).natural=function(...t){return this.on(e=>{let n;return(n=t.length>0?t:Object.keys(e[o]).map(t=>void 0!==e[a][t])).every(t=>{e[o][t],e[a][t]})}),this()},u.on=function(t){return c=t,this()},u},i.cross=s(async function*(n){const i="select"===n.name?n:t(e).from(n),s=Object.keys(r.queries)[0],o=Object.keys(i.queries)[0];return async function*(){for await(const[t,e]of l(r(),i())){let n={[s]:t,[o]:e},i=filter?await filter(n):n;i&&"object"==typeof i&&(yield Object.assign({},{[s]:i[s]},{[o]:i[o]}))}}()}),i}),r}(this,...t)}async serializable(t,{expireAt:e,atomic:n=(t&&t._?t._.atomic:void 0),save:i,explode:s}=this.options,r){if(!t)return;const o={},a=h(t,await this.getObject(t["#"],{read:!0,nocache:!0})),c=t.constructor.name;this.schema[c]||(this.schema[c]={ctor:t.constructor}),await this.bless(t,n,t._,e);for(const r in t){if("_"===r)continue;let a=t[r],u=typeof a;for await(const e of this.get(`${c}/${r}`)){const n=await this.getObject(t["#"]);u=typeof(a=await e.aclWrite(a,n?n[r]:void 0))}a&&"object"===u?M.isValueKeyed(a,"#")?o[r]=M.generateId(a):a._&&a._.atomic||(o[r]=await this.serializable(a,{expireAt:e,atomic:a._?a._.atomic:n,save:i,explode:s},!0)||a):o[r]=M.generateId(a)}if(t._){n&&void 0===t._atomic&&(t._.atomic=!0),o["#"]=t["#"],o._=Object.assign({},t._);for(const t of["createdAt","expireAt","modifiedAt"])o._[t]&&(o._[t]=this.compile(o._[t]));i&&!a&&o["#"]&&(await this.options.storage.setItem(o["#"],JSON.stringify(o)),this.cache.setItem(t["#"],t),await this.graph(t._,{indexDates:!0,leaf:t["#"]}))}return!r||n||s?o:o["#"]}async setItem(t,e){const n=await this.serializable(e,{explode:!0}),i=await this.options.storage.setItem(t,JSON.stringify(n));return this.options.indexAllObjects&&e&&"object"==typeof e&&await this.putItem(e),i}async ungraph(t,{indexDates:e,leaf:n}={}){const i=this.Edge();for(let s of this.getPaths(t,{indexDates:e})){n&&s.push(n);const t=s.shift();for await(const e of i.get(t,void 0,s)){const t=await e.parent();t&&await t.removeEdge(e.key)}}}version(t,{expireAt:e=(t._?t._.expireAt:void 0)}={}){const n=t._;n&&(n.version||(n.version=0),n.createdAt||(n.createdAt=new Date),e&&(n.expireAt=e),n.modifiedAt=new Date,n.version++)}}{const t=n(2),e=n(3);class i{constructor(t={}){e.pipeable(async function({match:t,handle:e}){return(!0===t||t.call(this,this))&&e?e.call(this,this):this}),this.handler=e(),this.options=Object.assign({},t)}use(t){return this.handler=this.handler.use(t),this}run(e=8080){return this.httpServer=t.createServer((t,e)=>{if(this.options.requestChangeLog){const e=this.options.requestChangeLog;t=new Proxy(t,{set(t,n,i){let s=t[n];if(s===i)return!0;t[n]=i;try{s=JSON.stringify(s)}catch(t){olvalue="[object Circular Object]"}try{i=JSON.stringify(i)}catch(t){i="[object Circular Object]"}return"_"!==n[0]&&e.log(`request.${n}=${i} was ${s}`),!0}})}this.handler.pipe([{req:t,res:e}])}),this.httpServer.listen(e,t=>{if(t)return console.log("something bad happened",t);console.log(`server is listening on ${e}`)}),this}}function nt(t,e){const n=async function({req:t,res:i}){const s=t.method.toLowerCase(),r=e[s]||e.default,o=e[s]?s:"default";return r&&((nt.trace||n.trace.includes(o))&&console.log(`Handler ${o} ${t.url}`),await r.call(this,this)),this};return n.trace=["get"],{match:function({req:e,res:n}){if(e&&!n.headersSent){const n=typeof t;if("function"===n){if(t(e))return(nt.trace||t.trace)&&console.log(`Route ${t.name} true ${e.url}`),!0;nt.trace&&console.log(`Route ${t.name} false ${e.url}`)}else if("object"===n&&t&&t instanceof RegExp){if(t.test(e.url))return nt.trace&&console.log(`Route ${t}.test("${e.url}") true ${e.url}`),!0;nt.trace&&console.log(`Route ${t}.test("${e.url}") false ${e.url}`)}else if("string"===n){if(e.url===t)return nt.trace&&console.log(`Route ${t}===${e.url} true ${e.url}`),!0;nt.trace&&console.log(`Route ${t}===${e.url} false ${e.url}`)}}},handle:n}}nt.trace=0,et.prototype.listen=function(t){const e=new i({requestChangeLog:console}),n=this;e.use(nt(function(){return!0},{default:({req:t})=>{t.remoteAddress=(t.headers["x-forwarded-for"]||"").split(",").pop()||t.connection.remoteAddress||t.socket.remoteAddress||t.connection.socket.remoteAddress}})).use(nt(function(){return!0},{default:({req:t})=>{t.referrer=t.headers.referer||t.headers.Referer||t.headers.Referrer}})).use(nt(function(){return!0},{default:({req:t,res:e})=>{e.setHeader("Access-Control-Allow-Origin","*")}})).use(nt(function(t){return 0===t.url.indexOf("/data/")},{default:({req:t})=>{const e=t.url.split("/");t.key=e.slice(2).join("/")}})).use(nt(function(){return!0},{put:async({req:t,res:e})=>new Promise(n=>{let i="";t.on("data",function(s){(i+=s).length>1e6&&(i="",e.writeHead(413,{"Content-Type":"text/plain"}).end(),t.connection.destroy(),n())}),t.on("end",function(){t.body={json:async()=>JSON.parse(i),text:async()=>i},n(!0)})})})).use(nt(function(t){return null!=t.key},{options:({req:t,res:e})=>{const n={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, DELETE, OPTIONS","Access-Control-Allow-Credentials":!0,"Access-Control-Max-Age":"86400","Access-Control-Allow-Headers":"Content-Length, Content-Type, Accept, If-Modified-Since"};e.writeHead(200,n),e.end()},get:async function({req:t,res:e}){if(u(t.key)){let i=await n.getObject(t.key);if(i){i=await n.serializable(i,{explode:!0});const t=JSON.stringify(i);e.setHeader("Content-Type","application/json;charset=utf-8"),e.setHeader("Content-Length",t.length),e.end(t)}return}const i=await n.options.storage.get("/"+t.key);if(i){const t=JSON.stringify(i);e.setHeader("Content-Type","application/json;charset=utf-8"),e.setHeader("Content-Length",t.length),e.end(t)}},put:async function({req:t,res:e}){const i=await t.body.json(),s=i["#"],r=function t(e){let n=[];for(const i in e){const s=e[i],r=typeof s;s&&"object"===r&&"_"!==i&&(s.atomic||(n=n.concat(t(s))),s["#"]&&(e[i]=s["#"]))}return e["#"]&&n.push(e),n}(i);for(const e of r)e&&(["createdAt","expireAt","modifiedAt"].forEach(t=>{if(e._[t]){const n=parseInt(e._[t].substring("Date@".length));e._[t]=new Date(n)}}),await n.putItem(e,{source:t.headers.referrer||t.headers.referer}));const o=await n.getObject(s),a=await n.serializable(o,{explode:!0}),c=JSON.stringify(a);e.setHeader("Content-Type","application/json;charset=utf-8"),e.setHeader("Content-Length",c.length),e.end(c)}})).use(nt(t=>!t.headersSent,{get:({req:t,res:e})=>{e.statusCode=404,e.end()}})),e.run(t),console.log(`${this.options.name||"AnyWhichWay Database"} started on ${t}`)}}n.d(e,"ReasonDB",function(){return it});const it={db:(...t)=>new et(...t),Database:et,Edge:f}}]);